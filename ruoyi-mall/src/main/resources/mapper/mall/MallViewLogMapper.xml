<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.mall.mapper.MallViewLogMapper">
    
    <resultMap type="com.ruoyi.mall.domain.MallViewLog" id="MallViewLogResult">
        <id     property="viewId"     column="view_id"     />
        <result property="userId"     column="user_id"     />
        <result property="goodsId"    column="goods_id"    />
        <result property="viewTime"   column="view_time"   />
        <result property="goodsName"  column="goods_name"  />
        <result property="goodsCover" column="goods_cover" />
        <result property="price"      column="price"       />
    </resultMap>

    <sql id="selectMallViewLogVo">
        select v.view_id, v.user_id, v.goods_id, v.view_time,
               g.goods_name, g.goods_cover, g.price
        from mall_view_log v
        left join mall_goods g on v.goods_id = g.goods_id
    </sql>

    <select id="selectMallViewLogList" parameterType="com.ruoyi.mall.domain.MallViewLog" resultMap="MallViewLogResult">
        <include refid="selectMallViewLogVo"/>
        <where>
            <if test="userId != null">
                AND v.user_id = #{userId}
            </if>
            <if test="goodsId != null">
                AND v.goods_id = #{goodsId}
            </if>
        </where>
        order by v.view_time desc
    </select>
    
    <select id="selectMallViewLogById" parameterType="Long" resultMap="MallViewLogResult">
        <include refid="selectMallViewLogVo"/>
        where v.view_id = #{viewId}
    </select>

    <select id="selectMallViewLogByUserId" parameterType="Long" resultMap="MallViewLogResult">
        <include refid="selectMallViewLogVo"/>
        where v.user_id = #{userId}
        order by v.view_time desc
    </select>

    <select id="selectMallViewLogByUserAndGoods" resultMap="MallViewLogResult">
        <include refid="selectMallViewLogVo"/>
        where v.user_id = #{userId} and v.goods_id = #{goodsId}
        limit 1
    </select>

    <select id="selectUserIdsByGoodsId" parameterType="Long" resultType="Long">
        select distinct user_id from mall_view_log where goods_id = #{goodsId}
    </select>

    <select id="selectGoodsIdsByUserId" parameterType="Long" resultType="Long">
        select distinct goods_id from mall_view_log where user_id = #{userId}
    </select>

    <select id="selectViewCountByGoodsId" parameterType="Long" resultType="int">
        select count(*) from mall_view_log where goods_id = #{goodsId}
    </select>
        
    <insert id="insertMallViewLog" parameterType="com.ruoyi.mall.domain.MallViewLog" useGeneratedKeys="true" keyProperty="viewId">
        insert into mall_view_log
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="userId != null">user_id,</if>
            <if test="goodsId != null">goods_id,</if>
            <if test="viewTime != null">view_time,</if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="userId != null">#{userId},</if>
            <if test="goodsId != null">#{goodsId},</if>
            <if test="viewTime != null">#{viewTime},</if>
        </trim>
    </insert>

    <update id="updateMallViewLog" parameterType="com.ruoyi.mall.domain.MallViewLog">
        update mall_view_log
        <trim prefix="SET" suffixOverrides=",">
            <if test="viewTime != null">view_time = #{viewTime},</if>
        </trim>
        where view_id = #{viewId}
    </update>

    <delete id="deleteMallViewLogById" parameterType="Long">
        delete from mall_view_log where view_id = #{viewId}
    </delete>

    <delete id="deleteMallViewLogByIds" parameterType="String">
        delete from mall_view_log where view_id in 
        <foreach item="viewId" collection="array" open="(" separator="," close=")">
            #{viewId}
        </foreach>
    </delete>
</mapper>
